- name: Création du ResourceGroup
  azure_rm_resourcegroup:
    location: "{{ local }}"
    name: "{{ resource_group }}"
- name: Création du VNet
  azure_rm_virtualnetwork:
    resource_group: "{{ resource_group }}"
    name: "{{ vnet_name }}"
    address_prefixes: "10.0.0.0/16"
- name: Création du AzureBastionSubnet
  azure_rm_subnet:
    resource_group: "{{ resource_group }}"
    name: AzureBastionSubnet
    virtual_network_name: "{{ vnet_name }}"
    address_prefix_cidr: "10.0.1.0/24"
  register: subnetbast
- name: Création du Subnet contenant les VM
  azure_rm_subnet:
    resource_group: "{{ resource_group }}"
    name: "{{ subnet_name }}"
    virtual_network_name: "{{ vnet_name }}"
    address_prefix: "10.0.2.0/24"
- name: Création du Subnet contenant l'app gateway
  azure_rm_subnet:
    resource_group: "{{ resource_group }}"
    name: subnet_ag
    virtual_network_name: "{{ vnet_name }}"
    address_prefix: "10.0.3.0/24" 
  register: subnetAG
- name: recuperer info subnet AG
  azure_rm_subnet_info:
    resource_group: "{{ resource_group }}"
    virtual_network_name: "{{ vnet_name }}"
    name: subnet_ag 
  register: subnet_outputs
- name: recuperer subnet id
  set_fact:
      subnet_id: "{{ subnet_outputs.subnets[0].id }}"   
- name: Création de l'IP publique du Bastion
  azure_rm_publicipaddress:
    resource_group: "{{ resource_group }}"
    allocation_method: Static
    name: ipbastion
    sku: standard
  register: ipbast
- debug:
    msg: "Adresse IP du Bastion: {{ ipbast.state.ip_address }}"
- name: Récupération de l'IP publique du Bastion
  azure_rm_publicipaddress_info:
    resource_group: "{{ resource_group }}"
    name: ipbastion
  register: publicIPbast
- name: Création de l'IP publique de l'AG
  azure_rm_publicipaddress:
    resource_group: "{{ resource_group }}"
    allocation_method: Static
    name: ipAG
    sku: standard
    domain_name : "{{ fqdn }}"
# register est la récupération de la sortie de la fonction dans une variable  ansible.builtin.shell
  register: ippub
- debug:
    msg: "Adresse IP Publique: {{ ippub.state.ip_address }}"
- name: Création du NSG
  azure_rm_securitygroup:
    resource_group: "{{ resource_group }}"
    name: myNetworkSecurityGroup
    rules:
      - name: SSH
        protocol: Tcp
        destination_port_range: 22
        access: Allow
        priority: 1001
        direction: Inbound
      - name: web
        protocol: Tcp
        destination_port_range: 80
        access: Allow
        priority: 1002
        direction: Inbound
      - name: webplus
        protocol: Tcp
        destination_port_range: 8080
        access: Allow
        priority: 1003
        direction: Inbound
      - name: websecur
        protocol: Tcp
        destination_port_range: 443
        access: Allow
        priority: 1004
        direction: Inbound

- name: Network Interface VM
  azure_rm_networkinterface:
    name: interface_vm
    resource_group: "{{ resource_group }}"
    virtual_network: "{{ vnet_name }}"
    subnet_name: "{{ subnet_name }}"
    create_with_security_group: False
    ip_configurations:
      - name: ipconfig1
        primary: True
    security_group: myNetworkSecurityGroup
- name: recuperer info interface réseau
  azure_rm_networkinterface_info:
    resource_group: "{{ resource_group }}"
    name: interface_vm
  register: network_interface_output
- name: recuperer ip privée
  set_fact:
    private_ip_vm: "{{ network_interface_output.networkinterfaces[0].ip_configurations[0].private_ip_address }}"
