---

- hosts: localhost
  vars:
    rg: test_thomas_app_gateway
    vnet: vnettest_app_gateway
    subnet_ag: subnet_app_gateway
  connection: local

  tasks:
    - name: Creation du groupe de ressources
      azure_rm_resourcegroup:
        location: eastus
        name: "{{ rg }}"
    - name: Creation du reseau virtuel
      azure_rm_virtualnetwork:
        resource_group: "{{ rg }}"
        name: "{{ vnet }}"
        address_prefixes: "10.0.0.0/16"
#creation subnet VM
    - name: Creation subnet VM
      azure_rm_subnet:
        resource_group: "{{ rg }}"
        name: subnet_VM
        virtual_network_name: "{{ vnet }}"
        address_prefix_cidr: "10.0.2.0/24"
      register: subnetVM
    #creation d'un subnet unique pour AG
    - name: Creation subnet AG
      azure_rm_subnet:
        resource_group: "{{ rg }}"
        name: "{{ subnet_ag }}"
        virtual_network_name: "{{ vnet }}"
        address_prefix_cidr: "10.0.1.0/24"
      register: subnetAG
    - name: recuperer info subnet AG
      azure_rm_subnet_info:
        resource_group: "{{ rg }}"
        virtual_network_name: "{{ vnet }}"
        name: "{{ subnet_ag }}"
      register: subnet_outputs
    - name: recuperer subnet id
      set_fact:
        subnet_id: "{{ subnet_outputs.subnets[0].id }}"
# creation ip publique AG, pas d'ip publique pour la VM
    - name: Creation de l IP publique AG
      azure_rm_publicipaddress:
        resource_group: "{{ rg }}"
        allocation_method: Static
        name: ipAG
        sku: standard
      register: ipAG
    - debug:
        msg: "Adresse IP AG: {{ ipAG.state.ip_address }}"
###
    - name: Creation du groupe de sécurité azure SSH
      azure_rm_securitygroup:
        resource_group: "{{ rg }}"
        name: myNetworkSecurityGroup
        rules:
          - name: SSH
            protocol: Tcp
            destination_port_range: 22
            access: Allow
            priority: 1001
            direction: Inbound
          - name: web
            protocol: Tcp
            destination_port_range: 80
            access: Allow
            priority: 1002
            direction: Inbound
          - name: webplus
            protocol: Tcp
            destination_port_range: 8080
            access: Allow
            priority: 1003
            direction: Inbound
          - name: websecur
            protocol: Tcp
            destination_port_range: 443
            access: Allow
            priority: 1004
            direction: Inbound
    - name: Network interface VM
      azure_rm_networkinterface:
        resource_group: "{{ rg }}"
        name: interface_1
        virtual_network: "{{ vnet }}"
        subnet: subnet_VM
        public_ip: False
        create_with_security_group: False
        ip_configurations:
          - name: ipconfig1
            primary: True
        security_group: myNetworkSecurityGroup
    - name: recuperer info interface réseau
      azure_rm_networkinterface_info:
        resource_group: "{{ rg }}"
        name: interface_1
      register: network_interface_output
    - name: recuperer ip privée
      set_fact:
        private_ip_vm: "{{ network_interface_output.networkinterfaces[0].ip_configurations[0].private_ip_address }}"
    - debug:
        msg: "{{ network_interface_output }}"
    - name: Creation de la VM
      azure_rm_virtualmachine:
        resource_group: "{{ rg }}"
        name: vmtest
        subnet_name: subnet_VM
        public_ip_allocation_method: Disabled
        vm_size: Standard_DS1_v2
        admin_username: thomas
        ssh_password_enabled: false
        ssh_public_keys:
          - path: /home/thomas/.ssh/authorized_keys
            key_data: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDQtaIPgHDrA4olC0mkDwPZqDA6ZHEVBJXUwf4kqwAHiUwnB0DtDlj0Vide0JJ56ODEEIojm3H8LExDRwxTWdFPn+JzwDVMA7xWqBBfcuykmzISXB2cTBR1AILhWIETAHtHZMqWBAZakfc5g1ik0VeQas6JAYHr0nzFdC9wO1FQJnbgoEHZERb4/Xxvxn/91GIvDqPwDRQr1OAutqUeenJyihip+US+Xnbrq/TmKKuQM+MJLrpMa2QlKoflo+7cs69q47v/W8EAx4x8RL77Woz8G5T8FvJuuPVkEcvqEUtb9cbnDaytSp02hYAYstsgW01cRgIVHXta5aK5o/0cmtU0vmMuECWZk18bDw3JkTgBzOKZ/cmJl1ur3qa9744tBKxu31LUbyOVYb92pc72s4lAfUESjPSiqSJ4nQ8iuGuwDDt3RVJEXKUCtnjDxGO8Qa8dgaK/LOEWCRTfLZ9yxo0ytEKCelVC2fVhBv1pJQubYb8R8IkqmcyoZ2+b5iOiVSIOgfijnEAh2aOTX/uTgcDNKYxxNpfTe0e+hXRfP/LL4QF+BF43uXwEEfw42I3X9jfO7Usd7LQndsIiA9B93gv87CtdoOIUCpRt4b4t1Q2d0cBhlS/YPqixauxMvpXJcUDISwoVCfmCjMNposBbIiyH4vrq91P4apb1u7oTmrNaTQ== thomas@host
        network_interfaces: interface_1
        image:
          offer: UbuntuServer
          publisher: Canonical
          sku: '18.04-LTS'
          version: latest
    - name: Create instance of Application Gateway
      azure_rm_appgateway:
        resource_group: "{{ rg }}"
        name: myAppGateway
        gateway_state: started
        sku:
          name: standard_small
          tier: standard
          capacity: 2
        gateway_ip_configurations:
          - subnet:
              id: "{{ subnet_id }}"
            name: app_gateway_ip_config
        frontend_ip_configurations:
          - subnet:
              id: "{{ subnet_id }}"
            name: sample_gateway_frontend_ip_config
        frontend_ports:
          - port: 80
            name: ag_frontend_port
        backend_address_pools:
          - backend_addresses:
              - ip_address: "{{ private_ip_vm }}"
            name: test_backend_address_pool
        backend_http_settings_collection:
          - port: 80
            protocol: http
            cookie_based_affinity: enabled
            name: sample_appgateway_http_settings
        http_listeners:
          - frontend_ip_configuration: sample_gateway_frontend_ip_config
            frontend_port: ag_frontend_port
            name: sample_http_listener
        request_routing_rules:
          - rule_type: Basic
            backend_address_pool: test_backend_address_pool
            backend_http_settings: sample_appgateway_http_settings
            http_listener: sample_http_listener
            name: rule1
    - name: Network interface AG
      azure_rm_networkinterface:
        resource_group: "{{ rg }}"
        name: interface_AG
        virtual_network: "{{ vnet }}"
        subnet: "{{ subnet_ag }}"
        create_with_security_group: False
        ip_configurations:
          - name: ipconfigAG
            primary: True
            application_gateway_backend_address_pools:
            - name: test_backend_address_pool
              application_gateway: myAppGateway